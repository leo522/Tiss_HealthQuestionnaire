@*認知篩檢-協調與平衡測驗*@
@model Tiss_HealthQuestionnaire.Models.CoordinationAndBalanceExaminationViewModel
@{
    Layout = "~/Views/Shared/_HealthLayout.cshtml";
}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta name="viewport" content="width=device-width" />
    <title>協調與平衡測驗</title>
</head>
<body>
    <div class="p-4">
        <h2 class="text-xl font-bold mb-4">協調與平衡測驗 (Coordination and Balance Examination)</h2>

        <!-- 改良版平衡姿勢檢測 -->
        <h3 class="text-lg font-semibold mb-2">1. 改良版平衡姿勢檢測 (Modified Balance Error Score System testing, mBESS)：</h3>

        <!-- 測試腳選項 -->
        <div class="mb-4">
            <label>測試腳 (非慣用腳)：</label>
            <label class="inline-flex items-center ml-2">
                <input type="radio" name="TestFoot" value="左" @(Model.ModifiedBalanceTest.TestFoot == "左" ? "checked" : "") /> 左
            </label>
            <label class="inline-flex items-center ml-4">
                <input type="radio" name="TestFoot" value="右" @(Model.ModifiedBalanceTest.TestFoot == "右" ? "checked" : "") /> 右
            </label>
        </div>

        <!-- 測試平面和腳穿著 -->
        <div class="mb-4">
            <label>測試平面 (硬地/訓練場)：</label>
            <input type="text" name="TestSurface" value="@Model.ModifiedBalanceTest.TestSurface" class="border border-gray-300 rounded px-2 py-1 w-full">
        </div>
        <div class="mb-4">
            <label>腳穿著 (赤足/球鞋/貼紮)：</label>
            <input type="text" name="Footwear" value="@Model.ModifiedBalanceTest.Footwear" class="border border-gray-300 rounded px-2 py-1 w-full">
        </div>

        <!-- 錯誤扣分表格 -->
        <table class="min-w-full bg-white border border-gray-300 text-center">
            <thead>
                <tr class="bg-gray-100">
                    <th>動作</th>
                    <th>錯誤扣分</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>雙腳站立</td>
                    <td><input type="number" name="DoubleLegErrorCount" value="@Model.ModifiedBalanceTest.DoubleLegErrorCount" class="border border-gray-300 rounded w-16 text-center error-input"></td>
                </tr>
                <tr>
                    <td>腳跟前後站立 (慣用腳在前)</td>
                    <td><input type="number" name="TandemStanceErrorCount" value="@Model.ModifiedBalanceTest.TandemStanceErrorCount" class="border border-gray-300 rounded w-16 text-center error-input"></td>
                </tr>
                <tr>
                    <td>單腳站立 (非慣用腳)</td>
                    <td><input type="number" name="SingleLegErrorCount" value="@Model.ModifiedBalanceTest.SingleLegErrorCount" class="border border-gray-300 rounded w-16 text-center error-input"></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="bg-gray-100">
                    <td class="font-semibold">總錯誤次數</td>
                    <td><span id="totalErrorCount">0</span> / 30</td>
                </tr>
            </tfoot>
        </table>

        <!-- 腳跟碰腳尖快速走路 -->
        <h3 class="text-lg font-semibold mt-6 mb-2">2. 腳跟碰腳尖快速走路 (Timed Tandem Gait)：</h3>

        <table class="min-w-full bg-white border border-gray-300 text-center">
            <thead>
                <tr class="bg-gray-100">
                    <th>第一次</th>
                    <th>第二次</th>
                    <th>第三次</th>
                    <th>平均時間</th>
                    <th>最快時間</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="number" name="FirstTrialTime" value="@Model.TimedTandemGait.FirstTrialTime" class="border border-gray-300 rounded w-16 text-center time-input" min="0" step="0.01"> 秒</td>
                    <td><input type="number" name="SecondTrialTime" value="@Model.TimedTandemGait.SecondTrialTime" class="border border-gray-300 rounded w-16 text-center time-input" min="0" step="0.01"> 秒</td>
                    <td><input type="number" name="ThirdTrialTime" value="@Model.TimedTandemGait.ThirdTrialTime" class="border border-gray-300 rounded w-16 text-center time-input" min="0" step="0.01"> 秒</td>
                    <td id="averageTime">0 秒</td>
                    <td id="fastestTime">0 秒</td>
                </tr>
            </tbody>
        </table>
        <!-- 表單按鈕 -->
        <div class="flex justify-between space-x-4 mt-4">
            <form action="/Questionnaire/Concentration" method="get">
                <button type="submit" class="bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600">回上一頁</button>
            </form>
            <form action="/Questionnaire/DelayedRecall" method="get">
                <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">接續下一頁</button>
            </form>
        </div>
    </div>

    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // 初始化並加載保存的數據
            loadScores();

            // 監聽錯誤扣分的輸入變更事件
            $('.error-input').on('input', function () {
                updateErrorCount();
                saveScores();
            });

            // 監聽時間輸入的輸入變更事件
            $('.time-input').on('input', function () {
                updateTimes();
                saveScores();
            });

            // 更新總錯誤次數
            function updateErrorCount() {
                let totalErrorCount = 0;
                $('.error-input').each(function () {
                    const value = parseInt($(this).val());
                    if (!isNaN(value)) {
                        totalErrorCount += value;
                    }
                });
                $('#totalErrorCount').text(totalErrorCount);
                sessionStorage.setItem('TotalErrorCount', totalErrorCount);
            }

            // 更新平均時間與最快時間
            function updateTimes() {
                const times = $('.time-input').map(function () {
                    const val = parseFloat($(this).val());
                    return isNaN(val) ? 0 : val;
                }).get();

                const validTimes = times.filter(time => time > 0);
                const averageTime = (validTimes.reduce((a, b) => a + b, 0) / (validTimes.length || 1)).toFixed(2);
                $('#averageTime').text(isNaN(averageTime) ? "0 秒" : averageTime + ' 秒');
                sessionStorage.setItem('AverageTime', averageTime);

                const fastestTime = validTimes.length > 0 ? Math.min(...validTimes).toFixed(2) : 0;
                $('#fastestTime').text(isNaN(fastestTime) ? "0 秒" : fastestTime + ' 秒');
                sessionStorage.setItem('FastestTime', fastestTime);
            }

            function saveScores() {
                $('.error-input, .time-input').each(function (index) {
                    sessionStorage.setItem(`inputValue_${index}`, $(this).val());
                });
            }

            function loadScores() {
                $('.error-input, .time-input').each(function (index) {
                    const savedValue = sessionStorage.getItem(`inputValue_${index}`);
                    if (savedValue !== null) {
                        $(this).val(savedValue);
                    }
                });

                const savedTotalErrorCount = sessionStorage.getItem('TotalErrorCount');
                if (savedTotalErrorCount !== null) {
                    $('#totalErrorCount').text(savedTotalErrorCount);
                }

                const savedAverageTime = sessionStorage.getItem('AverageTime');
                const savedFastestTime = sessionStorage.getItem('FastestTime');
                if (savedAverageTime !== null) {
                    $('#averageTime').text(savedAverageTime + ' 秒');
                }
                if (savedFastestTime !== null) {
                    $('#fastestTime').text(savedFastestTime + ' 秒');
                }
            }
        });
    </script>
</body>
</html>