@{
    ViewBag.Title = "Main";
    Layout = "~/Views/Shared/_HealthLayout.cshtml";
}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康檢查問卷</title>
    <link href="~/css/tailwind.min.css" rel="stylesheet" />
    <link href="~/css/mainStyle.css" rel="stylesheet" /> @*頁籤顏色*@
    @*<script src="~/js/questionnaire.js"></script>*@
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto">
        <form id="questionnaireForm" method="post" action="/Questionnaire/Preview">
            <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                    <div class="flex flex-col md:flex-row items-center mb-4 space-x-4">
                        <label class="mr-2">
                            專項：
                            <input type="text" name="specialist" class="border rounded p-1"
                                   value="@ViewBag.Specialist" readonly />
                        </label>
                        <label class="mr-2">
                            填表人：
                            <input type="text" name="fillName" class="border rounded p-1"
                                   value="@ViewBag.FillName" readonly />
                        </label>
                        <label class="mr-2">
                            選手編號：
                            <input type="text" name="atheNum" class="border rounded p-1"
                                   value="@ViewBag.AtheNum" readonly />
                            <input type="hidden" id="athleteNumber" value="@ViewBag.AtheNum" />
                        </label>
                        <label class="mr-2">
                            性別：
                            <input type="text" name="genderDisplay" class="border rounded p-1"
                                   value="@(ViewBag.GenderID == 1 ? "男" : "女")" readonly />
                            <input type="hidden" name="gender" value="@(ViewBag.GenderID)" />
                        </label>
                        <label class="mr-2">
                            填表日期：
                            <input type="date" name="fillDate" class="border rounded p-1" required />
                        </label>
                        <div class="flex space-x-4 ml-auto">
                            <button type="button" class="btn btn-success bg-green-500 text-white rounded px-6 py-2 whitespace-nowrap" id="previewButton">
                                預覽送出
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-wrap">
                    <!-- 修改這裡的 onclick 事件，增加 URL -->
                    @*<button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-l"
                            data-questionnaire-type="A" data-tab-name="PastHealth" data-url="/Questionnaire/PastHealth">
                        過去健康檢查病史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="B" data-tab-name="AllergicHistory" data-url="/Questionnaire/AllergicHistory">
                        過敏史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="C" data-tab-name="FamilyHistory" data-url="/Questionnaire/FamilyHistory">
                        家族病史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="D" data-tab-name="PastHistory" data-url="/Questionnaire/PastHistory">
                        過去病史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="E" data-tab-name="PresentIllness" data-url="/Questionnaire/PresentIllness">
                        現在病史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="F" data-tab-name="PastDrugs" data-url="/Questionnaire/PastDrugs">
                        藥物史
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="G" data-tab-name="PastSupplements" data-url="/Questionnaire/PastSupplements">
                        營養品
                    </button>*@

                    <button id="femaleQuestionnaireTab" class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 @(ViewBag.ShowFemaleTab ? "" : "hidden")"
                            data-questionnaire-type="H" data-tab-name="FemaleQuestionnaire" data-url="/Questionnaire/FemaleQuestionnaire">
                        女性問卷
                    </button>

                    @*<button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="I" data-tab-name="PastInjuryRestored" data-url="/Questionnaire/PastInjuryRestored">
                        過去傷害狀況 (已復原)
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="J" data-tab-name="NowInjuryRestored" data-url="/Questionnaire/NowInjuryRestored">
                        目前傷害狀況
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="K" data-tab-name="CardiovascularScreening" data-url="/Questionnaire/CardiovascularScreening">
                        心血管篩檢
                    </button>

                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="L" data-tab-name="ConcussionScreening" data-url="/Questionnaire/ConcussionScreening">
                        腦震盪篩檢-選手自填
                    </button>
                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="L" data-tab-name="SymptomEvaluation" data-url="/Questionnaire/SymptomEvaluation">
                        症狀自我評估-選手自填(2)
                    </button>
                    <button class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4"
                            data-questionnaire-type="M" data-tab-name="OrthopaedicScreening" data-url="/Questionnaire/OrthopaedicScreening">
                        骨科篩檢
                    </button>*@

                    @*防護員專屬頁籤按鈕*@
                    @*<button id="tab_CognitiveScreening" class="tablinks w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4" data-questionnaire-type="N" data-tab-name="CognitiveScreening" data-url="/Questionnaire/CognitiveScreening">
                        腦震盪篩檢-醫療團隊評估
                    </button>*@
                </div>
            </div>

            <div id="tabContent"></div> <!-- 頁籤內容會在點擊時載入 -->
        </form>

        <!-- 醫療團隊身份驗證對話框 -->
        <div id="athleticTrainerModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">醫療團隊身份驗證</h3>
                <form id="trainerAuthForm">
                    <div class="form-group mb-2">
                        <label for="trainerUserName">醫療團隊帳號</label>
                        <input type="text" class="form-control" id="trainerUserName" name="trainerUserName" required>
                    </div>
                    <div class="form-group mb-4">
                        <label for="trainerPassword">密碼</label>
                        <input type="password" class="form-control" id="trainerPassword" name="trainerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">驗證</button>
                </form>
                <button id="closeModal" class="mt-2 text-red-500">取消</button>
            </div>
        </div>

    </div>
    <script>
        let currentQuestionnaireTypeCode = ''; // 全域變數

        $(document).ready(function () {
            // 頁籤按鈕事件
            $('.tablinks').on('click', function (e) {
                e.preventDefault();
                const tabName = $(this).data('tab-name');
                const url = $(this).data('url');

                saveTabDataToSession(tabName); // 保存當前頁籤數據
                openTab(tabName, url); // 加載下一頁籤
            });

            // 預覽按鈕事件
            $('#previewButton').click(async function (e) {
                e.preventDefault();

                const fillDate = $('input[name="fillDate"]').val();
                if (!fillDate) {
                    Swal.fire({
                        icon: 'warning',
                        title: '日期未選擇',
                        text: '請選擇填表日期！',
                        confirmButtonText: '確定'
                    });
                    return;
                }

                // 保存所有頁籤數據
                $('.tablinks').each(function () {
                    const tabName = $(this).data('tab-name');
                    saveTabDataToSession(tabName);
                });

                $('#questionnaireForm').submit();
            });
        });

        // 保存頁籤數據
        function saveTabDataToSession(tabName) {
            const formData = $(`#${tabName}`).find('input, textarea, select').serializeArray();
            const tabData = {};
            formData.forEach(item => {
                tabData[item.name] = item.value;
            });

            const uniqueKey = `TabData_${tabName}`; // 唯一鍵
            sessionStorage.setItem(uniqueKey, JSON.stringify(tabData)); // 存入 sessionStorage
            $.post('/Questionnaire/SaveTabData', { tabName: uniqueKey, tabData: JSON.stringify(tabData) }); // 傳送至後端
        }

        // 打開頁籤
        function openTab(tabName, url) {
            const safeTabName = tabName.replace(/[^a-zA-Z0-9-_]/g, '');

            $('.tabcontent').hide();
            $('.tablinks').removeClass('active');
            $(`[data-tab-name="${safeTabName}"]`).addClass('active');

            if (!$(`#${safeTabName}`).length) {
                $.get(url, function (data) {
                    $('<div>', { id: safeTabName, class: 'tabcontent' }).html(data).appendTo('#tabContent').show();
                }).fail(function () {
                    Swal.fire({
                        icon: 'error',
                        title: '頁面加載失敗',
                        text: '請稍後再試。',
                        confirmButtonText: '確定'
                    });
                });
            } else {
                $(`#${safeTabName}`).show();
            }
        }
    </script>

    @*<script>
            let currentQuestionnaireTypeCode = ''; // 全域變數

            $(document).ready(function () {
                // 點擊頁籤按鈕
                $('.tablinks').on('click', function (e) {
                    e.preventDefault();

                    const tabName = $(this).data('tab-name');
                    const url = $(this).data('url');
                    currentQuestionnaireTypeCode = $(this).data('questionnaire-type');

                    saveTabDataToSession(tabName);

                    // 判斷是否需要醫療團隊身份驗證
                    if (tabName === "CognitiveScreening") {
                        // 檢查是否已通過驗證
                        if (isTrainerAuthenticated()) {
                            openTab(tabName, url); // 如果已驗證，直接打開頁籤
                        } else {
                            showTrainerAuthModal(e, tabName, url); // 如果未驗證，顯示身份驗證對話框
                        }
                    } else {
                        // 其他頁籤直接打開
                        openTab(tabName, url);
                    }
                });

                // 初始化表單輸入監聽事件
                $('#questionnaireForm input, #questionnaireForm select, #questionnaireForm textarea').on('change', function () {
                    const currentTabName = $(this).closest('.tabcontent').attr('id');
                    saveTabDataToSession(currentTabName);
                });

                // 預覽按鈕事件
                $('#previewButton').click(async function (e) {
                    e.preventDefault();

                    const fillDate = $('input[name="fillDate"]').val();
                    if (!fillDate) {
                        Swal.fire({
                            icon: 'warning',
                            title: '日期未選擇',
                            text: '請選擇填表日期！',
                            confirmButtonText: '確定'
                        });
                        return;
                    }

                    // 確保所有頁籤數據保存
                    $('.tablinks').each(function () {
                        const tabName = $(this).data('tab-name');
                        saveTabDataToSession(tabName);
                    });

                    // 驗證所有問卷內容
                    if (!validateAllQuestionnaires()) {
                        Swal.fire({
                            icon: 'error',
                            title: '問卷未完成',
                            text: '請確保所有問卷內容已填寫完整！',
                            confirmButtonText: '確定'
                        });
                        return;
                    }

                    sessionStorage.clear();
                    $('#questionnaireForm').submit();
                });
            });

            // 醫療團隊身份驗證狀態相關函數
            function isTrainerAuthenticated() {
                return sessionStorage.getItem('TrainerAuthenticated') === 'true';
            }

            //跨頁籤共享驗證狀態
            function setTrainerAuthenticated() {
                sessionStorage.setItem('TrainerAuthenticated', 'true');
            }

            //頁籤切換時檢查後端狀態
            function verifyTrainerSession() {
                return $.get('/Questionnaire/CheckTrainerSession').then(function (response) {
                    return response.authenticated; // 從後端返回驗證結果
                });
            }

            // 顯示醫療團隊身份驗證對話框
            function showTrainerAuthModal(evt, tabName, url) {
                evt.preventDefault();
                document.getElementById('athleticTrainerModal').classList.remove('hidden');

                // 綁定表單提交事件
                $('#trainerAuthForm').off('submit').on('submit', function (e) {
                    e.preventDefault();
                    authenticateTrainer(url, tabName);
                });

                // 綁定取消按鈕事件
                $('#closeModal').off('click').on('click', function () {
                    document.getElementById('athleticTrainerModal').classList.add('hidden');
                });
            }

            // 醫療團隊身份驗證
            function authenticateTrainer(url, tabName) {
                const userName = $('#trainerUserName').val();
                const password = $('#trainerPassword').val();

                $.post('/Questionnaire/ValidateAthleticTrainer', { userName, password }, function (response) {
                    if (response.success) {
                        setTrainerAuthenticated(); // 設置驗證狀態
                        document.getElementById('athleticTrainerModal').classList.add('hidden');
                        openTab(tabName, url); // 驗證成功後打開頁籤
                    } else {
                        alert('身份驗證失敗，請確認帳號與密碼。');
                    }
                }).fail(function () {
                    alert('驗證時發生錯誤，請稍後再試。');
                });
            }

            // 開啟頁籤
            function openTab(tabName, url) {
                const safeTabName = tabName.replace(/[^a-zA-Z0-9-_]/g, '');

                // 更新 URL
                history.pushState({ tabName: safeTabName }, '', url);

                $('.tabcontent').hide();
                $('.tablinks').removeClass('active');
                $(`[data-tab-name="${safeTabName}"]`).addClass('active');

                if ($('#' + safeTabName).length === 0) {
                    $.get(url, function (data) {
                        $('<div>', { id: safeTabName, class: 'tabcontent' }).html(data).appendTo('#tabContent').show();
                    }).fail(function (xhr) {
                        if (xhr.status === 403 || xhr.status === 401) {
                            alert('只有防護員可以訪問此頁面。');
                        } else {
                            alert('載入頁面時發生錯誤，請稍後再試。');
                        }
                    });
                } else {
                    $('#' + safeTabName).show();
                }
            }

            // 保存頁籤數據到 Session
            function saveTabDataToSession(tabName) {
                const formData = $(`#${tabName}`).find('input, textarea, select').serializeArray();
                const tabData = {};
                formData.forEach(item => {
                    tabData[item.name] = item.value;
                });

                sessionStorage.setItem(tabName, JSON.stringify(tabData)); // 保存到 sessionStorage
                $.post('/Questionnaire/SaveTabData', { tabName, tabData: JSON.stringify(tabData) }); // 同步到後端
            }

            // 載入所有頁籤數據到 SessionStorage
            function loadAllTabData() {
                return new Promise((resolve) => {
                    $('.tablinks').each(function () {
                        const tabName = $(this).data('tab-name');
                        const url = $(this).data('url');
                        $.get(url, function (data) {
                            // 將每個頁籤數據保存到 SessionStorage
                            sessionStorage.setItem(tabName, JSON.stringify(data));
                        }).fail(function () {
                            Swal.fire({
                                icon: 'error',
                                title: '數據加載失敗',
                                text: `頁籤 ${tabName} 數據無法載入，請重試。`,
                                confirmButtonText: '確定'
                            });
                            resolve(false); // 失敗時返回 false
                        });
                    });
                    resolve(true); // 成功時返回 true
                });
            }
            // 從 sessionStorage 恢復數據
            function restoreTabDataFromSession(tabName) {
                const savedData = sessionStorage.getItem(tabName);
                if (savedData) {
                    const dataObject = JSON.parse(savedData);
                    for (const key in dataObject) {
                        const input = $(`[name="${key}"]`);
                        if (input.attr('type') === 'radio' || input.attr('type') === 'checkbox') {
                            input.prop('checked', input.val() === dataObject[key]);
                        } else {
                            input.val(dataObject[key]);
                        }
                    }
                }
            }

            // 在頁籤切換時保存當前數據
            $('.tablinks').on('click', function () {
                const currentTabName = $(this).data('tab-name');
                saveTabDataToSession(currentTabName);
            });

            // 在頁籤加載時調用
            $('.tablinks').on('click', function () {
                const tabName = $(this).data('tab-name');
                restoreTabDataFromSession(tabName);
            });

            // 驗證所有問卷內容是否完整
            function validateAllQuestionnaires() {
                let isValid = true;

                // 檢查是否每組 radio 都有被選中
                $('#questionnaireForm').find('[data-type="radio"]').each(function () {
                    const groupName = $(this).find('input[type="radio"]').attr('name');
                    if (!$(`input[name="${groupName}"]:checked`).val()) {
                        isValid = false;
                        return false; // 停止迴圈
                    }
                });

                return isValid;
            }
        </script>*@
</body>
</html>